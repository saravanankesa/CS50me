{% extends 'monemome/layout.html' %}

{% block content %}
<div class="container">
    <div class="sub-header">
        <div class="btn-group" role="group" aria-label="Transaction navigation">
            <a href="{% url 'list_transactions' %}" class="btn btn-secondary">List Transactions</a>
            <a href="{% url 'add_transaction' %}" class="btn btn-secondary">Add Transaction</a>
            <a href="{% url 'pre_auth_payments' %}" class="btn btn-secondary">Pre-Auth Payments</a>
            <a href="{% url 'recurring_incomes' %}" class="btn btn-secondary">Recurring Incomes</a>
        </div>
    </div>
    <h2>Edit Transaction</h2>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-danger" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </form>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Convert p tags to div with class form-group
    $('#form-container p').each(function() {
        var $div = $('<div>').addClass('form-group').html($(this).html());
        var $input = $(this).find('input, select');

        if ($input.length) {
            $div.attr('id', 'div_' + $input.attr('name'));
            if ($input.attr('name') === 'is_pre_auth') {
                $div.addClass('expense-only');
            } else if ($input.attr('name') === 'is_recurring') {
                $div.addClass('income-only');
            }
        }

        $(this).replaceWith($div);
    });

    // Handle transaction type change
    $('input[name="transaction_type"]').change(function() {
        updateFormFields();
        loadCategories($(this).val());
    });

    // Initialize the form on page load
    if ($('input[name="transaction_type"]:checked').length) {
        updateFormFields();
        loadCategories($('input[name="transaction_type"]:checked').val());
    }
});

function updateFormFields() {
    var transactionType = $('input[name="transaction_type"]:checked').val();
    $('.form-group').hide();
    $('.transaction-type').show();

    if (transactionType === 'Income') {
        $('.expense-only').hide();
        $('.income-only').show();
    } else if (transactionType === 'Expense') {
        $('.income-only').hide();
        $('.expense-only').show();
    }

    $('.common-fields').show();
}

function loadCategories(transactionType) {
    $.ajax({
        url: `/api/categories/${transactionType}/`,
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            var $categorySelect = $('#id_category');
            $categorySelect.empty();
            $.each(data, function(i, cat) {
                $categorySelect.append(new Option(cat.category_name, cat.id));
            });
            $categorySelect.show();
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error('Error loading categories:', errorThrown);
        }
    });
}
</script>

    
{% endblock %}
