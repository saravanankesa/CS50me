{% extends 'monemome/layout.html' %}

{% block content %}
<div class="container">
    <div class="sub-header">
        <div class="btn-group" role="group" aria-label="Transaction navigation">
            <a href="{% url 'list_transactions' %}" class="btn btn-subheader">List Transactions</a>
            <a href="{% url 'add_transaction' %}" class="btn btn-subheader">Add Transaction</a>
            <a href="{% url 'pre_auth_payments' %}" class="btn btn-subheader">Pre-Auth Payments</a>
            <a href="{% url 'recurring_incomes' %}" class="btn btn-subheader">Recurring Incomes</a>
        </div>
    </div>
    <p><h2>Add Transaction</h2></p>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-danger" role="alert">
                {{ message|safe }}
            </div>
        {% endfor %}
    {% endif %}
    <form method="post" action="{% url 'add_transaction' %}">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Handling form container paragraphs
    $('#form-container p').each(function() {
        var $div = $('<div>').addClass('form-group').html($(this).html());
        var $input = $(this).find('input, select');

        if ($input.length) {
            $div.attr('id', 'div_' + $input.attr('name'));
            if ($input.attr('name') === 'is_pre_auth') {
                $div.addClass('expense-only');
            } else if ($input.attr('name') === 'is_recurring') {
                $div.addClass('income-only');
            }
        }

        $(this).replaceWith($div);
    });

    // Insert error paragraph for category selection if needed
    var $categorySelect = $('select[name="category"]');
    if ($categorySelect.length) {
        $('<p>').attr('id', 'category-error').addClass('text-danger').insertAfter($categorySelect);
    }

    // Event handling for radio button changes
    $('input[name="transaction_type"]').change(function() {
        updateFormFields();
        loadCategories($(this).val());
    });

    // Initialize the form fields and category loading on page load
    if ($('input[name="transaction_type"]:checked').length) {
        updateFormFields();
        loadCategories($('input[name="transaction_type"]:checked').val());
    }
});

function updateFormFields() {
    var transactionType = $('input[name="transaction_type"]:checked').val();
    $('.form-group').hide();
    $('.transaction-type').show();
    
    if (transactionType === 'Income') {
        $('.expense-only').hide();
        $('.income-only').show();
    } else if (transactionType === 'Expense') {
        $('.income-only').hide();
        $('.expense-only').show();
    }

    $('.common-fields').show();
    loadCategories(transactionType);
}

function loadCategories(transactionType) {
    $.ajax({
        url: `/api/categories/${transactionType}/`,
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            var $categorySelect = $('#id_category');
            $categorySelect.empty();

            if (data.length === 0) {
                $categorySelect.html('<option>No categories available</option>');
            } else {
                $.each(data, function(i, cat) {
                    $categorySelect.append(new Option(cat.category_name, cat.id));
                });
            }

            $categorySelect.show();
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error('Error loading categories:', errorThrown);
            $('#category-error').text('Failed to load categories. Please try again.');
        }
    });
}
</script>

    

{% endblock %}
